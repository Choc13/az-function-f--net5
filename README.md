# Example Azure Function using F# on .NET 5

This repo shows a minimal example of how to write an Azure function using F# and run it on .NET 5.
It also includes an example of deploying to Azure from your local machine and using GitHub actions.

## Gotchas

There were several gotchas that were discovered when trying to get this to work which were often tricky to find in the existing documentation. In fact, all of these gotchas apply equally to a CSharp project trying to run on .NET 5.

1. ### Isolated .NET Host
    Running the function on .NET 5 requires an [isolated .NET host](https://docs.microsoft.com/en-us/azure/azure-functions/dotnet-isolated-process-guide). 
    Specifically, we have to set the environment variable `FUNCTIONS_WORKER_RUNTIME` to the value `"dotnet-isolated"`.
    This is because the default host in the functions runtime is still using .NET Core 3.1.
    We have to set this in both the [`local.settings.json`](local.settings.json) file for running locally and the [ARM template](azuredeploy.json) for running in Azure.
1. ### Build requires .NET 3 SDK
    Although our code is targeting `net5.0` we need both the .NET 5 and .NET Core 3.1 SDK installed in order to build the  project. More details can be found in this [GitHub issue](https://github.com/Azure/azure-functions-dotnet-worker/issues/480).
1. ### Correct Worker Extensions Packages
    The templates generated by Visual Studio etc don't seem to include the correct NuGet function extensions packages for the isolated hosting model. See the [Function.fsproj](src/Function/Function.fsproj) file for the correct packages to use with the isolated hosting model. Note, this project is using `Microsoft.Azure.Functions.Worker.Extensions.Timer` because this basic example just uses a simple timer trigger, you might need a different extension package if you're using a different trigger, e.g. Blob triggers require `Microsoft.Azure.Functions.Worker.Extensions.Storage`.
1. ### `_FunctionsSkipCleanOutput` Attribute
    Again, the templates don't always require all of the necessary MSBuild settings. The .fsproj should contain `<_FunctionsSkipCleanOutput>True</_FunctionsSkipCleanOutput>`.
1. ### `<None Include=>` instead of `<None Update=>`
    Another issue with the templates is that the settings files (`host.json` and `local.settings.json`) have the wrong compile directives, they should use `<None Include=>`.
1. ### Use `dotnet build` instead of `dotnet publish`
    When publishing an ASP.NET app it's typical to run `dotnet publish` to generate the necessary runtime artifacts such as a `web.config`. Oddly, with an Azure function we just run `dotnet build` instead. See the [GitHub workflow](.github/workflows/build-and-deploy.yml#L28) for an example.

## Deployment

### Pre-requisites

Before getting started you'll need an Azure description and a resource group, you'll also need to installed the [az cli](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli).

You can create the resource group with the `az cli` like this:

```sh
az group create -n <resource-group-name> -l <location>
```

### Steps

1. Build the function app.

    ```sh
    dotnet build src/Function -c Release -o .publish/func
    ./deploy.sh .publish/func/ -g <name-of-your-resource-group>
    ```

2. Deploy to Azure

    ```sh
    ./deploy.sh .publish/func/ -g <name-of-your-resource-group>
    ```

### GitHub

This repo also includes a [GitHub workflow](.github/workflows/build-and-deploy.yml) that will run the above steps on each commit to the `master` branch.

## Running Locally

Instruction for how to run the function locally to debug:
* Need to install Azurite and the func tools
* Run Azurite in loose mode
* Set storage connection string to UseDevelopment=true
* Run the func command

## Issues deploying this sample, other questions relating to Azure functions with F#?

Open an issue and let me know.
